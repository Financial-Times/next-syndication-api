version: 2.1
orbs:
  tool-kit: financial-times/dotcom-tool-kit@4
jobs:
  checkout:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - tool-kit/persist-workspace:
          path: .
  envTest:
    executor: tool-kit/default
    steps:
      - checkout
      - run:
          command: node ~/project/scripts/env_check.js
workflows:
  tool-kit:
    when:
      not:
        equal:
          - scheduled_pipeline
          - << pipeline.trigger_source >>
    jobs:
      - checkout
      - waiting-for-approval:
          type: approval
          filters:
            branches:
              only: /(^renovate-.*|^nori/.*)/
      - tool-kit/setup:
          requires:
            - checkout
            - waiting-for-approval
      - envTest:
          requires:
            - checkout
            - waiting-for-approval
            - tool-kit/setup
      - tool-kit/build:
          requires:
            - envTest
            - tool-kit/setup
      - tool-kit/test:
          requires:
            - tool-kit/build
      - tool-kit/heroku-provision:
          requires:
            - tool-kit/setup
            - waiting-for-approval
          filters:
            branches:
              ignore: main
      - tool-kit/heroku-staging:
          requires:
            - tool-kit/setup
          filters:
            branches:
              only: main
      - tool-kit/e2e-test-review:
          requires:
            - tool-kit/heroku-provision
      - tool-kit/e2e-test-staging:
          requires:
            - tool-kit/heroku-staging
      - tool-kit/heroku-promote:
          requires:
            - envTest
            - tool-kit/e2e-test-staging
            - tool-kit/test
          filters:
            branches:
              only: main
  nightly:
    when:
      and:
        - equal:
            - scheduled_pipeline
            - << pipeline.trigger_source >>
        - equal:
            - nightly
            - << pipeline.schedule.name >>
    jobs:
      - checkout
      - tool-kit/setup:
          requires:
            - checkout
      - tool-kit/build:
          requires:
            - tool-kit/setup
      - tool-kit/test:
          requires:
            - tool-kit/build
      - tool-kit/heroku-provision:
          requires:
            - tool-kit/setup
